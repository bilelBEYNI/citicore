{% extends 'back/Dashboard.html.twig' %}

{% block title %}Statistiques des RÃ©ponses{% endblock %}

{% block body %}
  <div class="container my-5" style="margin-left:300px;">

    {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RÃ©clamations par Type â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
    <h2 class="mb-4">ðŸ“Š RÃ©ponses par Type de RÃ©clamation</h2>
    <div id="chartByTypeDiv" style="height: 400px; width: 700px;"></div>

    {% if typeFilter %}
      <h3 class="mt-4">RÃ©clamations de type Â« {{ typeFilter }} Â»</h3>
      <table class="table table-striped table-bordered mt-2">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Sujet</th>
            <th>Date de crÃ©ation</th>
          </tr>
        </thead>
        <tbody>
          {% for rec in reclamations %}
            <tr>
              <td>{{ rec.ID_Reclamation }}</td>
              <td>{{ rec.Sujet }}</td>
              <td>{{ rec.Date_Creation|date('Y-m-d') }}</td>
            </tr>
          {% else %}
            <tr>
              <td colspan="3" class="text-center">Aucune rÃ©clamation</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}

    {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RÃ©ponses par Statut â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
    <h2 class="mb-4 pt-5">ðŸ“ˆ RÃ©ponses par Statut</h2>
    <div id="chartByStatusDiv" style="height: 400px; width: 700px;"></div>

    {% if statusFilter %}
      <h3 class="mt-4">RÃ©ponses au statut Â« {{ statusFilter }} Â»</h3>
      <table class="table table-striped table-bordered mt-2">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Statut</th>
            <th>Date de rÃ©ponse</th>
          </tr>
        </thead>
        <tbody>
          {% for resp in responses %}
            <tr>
              <td>{{ resp.ID_Reponse }}</td>
              <td>{{ resp.Statut }}</td>
              <td>{{ resp.dateReponse|date('Y-m-d') }}</td>
            </tr>
          {% else %}
            <tr>
              <td colspan="3" class="text-center">Aucune rÃ©ponse</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>

  <script>
    google.charts.setOnLoadCallback(function() {
      // --- Chart Type ---
      var dataByType = new google.visualization.arrayToDataTable([
        ['Type','Nombre'],
        {% for row in chartByTypeData %}
          ['{{ row.type }}', {{ row.count }}],
        {% endfor %}
      ]);
      var chartByType = new google.visualization.PieChart(
        document.getElementById('chartByTypeDiv')
      );
      chartByType.draw(dataByType, {
        title: 'RÃ©ponses par Type de RÃ©clamation',
        legend: { position: 'bottom' }
      });
      // listener
      google.visualization.events.addListener(chartByType, 'select', function() {
        var sel = chartByType.getSelection()[0];
        if (!sel) return;
        var type = dataByType.getValue(sel.row, 0);
        // reload avec filtre
        window.location.search = '?Type=' + encodeURIComponent(type);
      });

      // --- Chart Status ---
      var dataByStatus = new google.visualization.arrayToDataTable([
        ['Statut','Nombre'],
        {% for row in chartByStatusData %}
          ['{{ row.statut }}', {{ row.count }}],
        {% endfor %}
      ]);
      var chartByStatus = new google.visualization.ColumnChart(
        document.getElementById('chartByStatusDiv')
      );
      chartByStatus.draw(dataByStatus, {
        title: 'RÃ©ponses par Statut',
        vAxis: { title: 'Nombre' },
        hAxis: { title: 'Statut' }
      });
      // listener
      google.visualization.events.addListener(chartByStatus, 'select', function() {
        var sel = chartByStatus.getSelection()[0];
        if (!sel) return;
        var statut = dataByStatus.getValue(sel.row, 0);
        window.location.search = '?status=' + encodeURIComponent(statut);
      });
    });
  </script>
{% endblock %}
