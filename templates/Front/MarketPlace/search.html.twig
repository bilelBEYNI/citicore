{% extends 'base.html.twig' %}

{% set session = app.session %}
{% set panier  = session.get('panier', {}) %}

{% block title %}Recherche: "{{ searchQuery }}"{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="{{ asset('styles/marketplace/shop.css') }}">
{% endblock %}

{% block body %}
  <div class="container my-5" style="margin-left: 250px; padding-bottom: 50px;">
    <h1 class="shop-title">Résultats pour "{{ searchQuery }}"</h1>

    {# Réutilisation du même code d’affichage des produits #}
    {% if produits is empty %}
      <p>Aucun produit trouvé.</p>
    {% else %}
      <div class="row">
        {% for produit in produits %}
          {% set inCart = produit.id_produit in panier %}
          <div class="col-md-3 mb-4 d-flex align-items-stretch">
            <div class="card product-card shadow-sm border-0 position-relative">
              <a href="{{ path('app_favoris_toggle', {id: produit.id_produit}) }}"
                 class="fav-icon {% if produit.id_produit in session.get('favoris', []) %}active{% endif %}">
                <i class="fas fa-heart"></i>
              </a>

              <img src="{{ asset('uploads/' ~ produit.photo) }}"
                   class="card-img-top" alt="{{ produit.nom }}">

              <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ produit.nom|upper }}</h5>
                <p class="price">{{ produit.prix }} €</p>
                <div class="mt-auto btn-group w-100">
                  <a href="{{ path('app_produit_detail', {id: produit.id_produit}) }}"
                     class="btn btn-details">Détails</a>
                  {% if not inCart %}
                    <a href="{{ path('app_cart_add', {id: produit.id_produit}) }}"
                       class="btn btn-success add-to-cart"
                       data-product-id="{{ produit.id_produit }}">
                      <i class="fas fa-shopping-bag me-2"></i> Ajouter
                    </a>
                  {% else %}
                    <button class="btn btn-secondary already-added">
                      <i class="fas fa-shopping-bag me-2"></i> Déjà ajouté
                    </button>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <a href="{{ path('app_cart') }}" class="floating-cart">
    <i class="fas fa-shopping-cart"></i>
    {% if cartCount > 0 %}
      <span class="badge">{{ cartCount }}</span>
    {% endif %}
  </a>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  {# même script AJAX que sur index.html.twig #}
  <script>
    $(document).on('click', '.btn.add-to-cart', function(e) { /* … */ });
    $(document).on('click', '.already-added', function(e) { /* … */ });
  </script>
{% endblock %}
