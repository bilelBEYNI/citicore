{% extends 'base.html.twig' %}

{% set session = app.session %}
{% set cart = session.get('cart', {}) %}

{% block title %}Bienvenue dans notre Boutique{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="{{ asset('styles/marketplace/shop.css') }}">
{% endblock %}

{% block body %}
  <div class="container my-5" style="margin-left: 250px; padding-bottom: 50px;">
    <h1 class="shop-title">Bienvenue dans notre Shop</h1>
<!-- Icône Favoris -->
{% set favoris = app.session.get('favoris', [])|filter(v => v is not empty) %}
<li>
    <a href="{{ path('app_favoris') }}" class="position-relative">
        <i class="fas fa-heart"></i> Favoris
        {% if favoris|length > 0 %}
            <span class="badge position-absolute top-0 start-100 translate-middle bg-danger">
                {{ favoris|length }}
                <span class="visually-hidden">nombre de favoris</span>
            </span>
        {% endif %}

    {% for message in app.flashes('success') %}
      <div class="alert alert-success">{{ message }}</div>
    {% endfor %}
    {% for message in app.flashes('warning') %}
      <div class="alert alert-warning">{{ message }}</div>
    {% endfor %}

    <div class="row">
      {% for produit in produits %}
        {% set inCart = produit.id in cart %}
        <div class="col-md-3 mb-4 d-flex align-items-stretch">
          <div class="card product-card shadow-sm border-0 position-relative">
            <a href="{{ path('app_favoris_toggle', {id: produit.id}) }}"
               class="fav-icon {% if produit.id in session.get('favoris', []) %}active{% endif %}">
              <i class="fas fa-heart"></i>
            </a>

            <img src="{{ asset('uploads/' ~ produit.photo) }}" class="card-img-top" alt="{{ produit.nom }}">

            <div class="card-body d-flex flex-column">
              <h5 class="card-title">{{ produit.nom|upper }}</h5>
              <p class="price">{{ produit.prix }} €</p>
              <div class="mt-auto btn-group w-100">
                <a href="{{ path('app_produit_detail', {id: produit.id}) }}" class="btn btn-details">Détails</a>
                {% if not inCart %}
                  <a href="{{ path('app_cart_add', {id: produit.id}) }}"
                     class="btn btn-success add-to-cart"
                     data-product-id="{{ produit.id }}">
                    <i class="fas fa-shopping-bag me-2"></i> Ajouter
                  </a>
                {% else %}
                  <button class="btn btn-secondary already-added">
                    <i class="fas fa-shopping-bag me-2"></i> Déjà ajouté
                  </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <p class="col-12 text-center">Aucun produit disponible.</p>
      {% endfor %}
    </div>
  </div>

  <!-- Panier flottant -->
  <a href="{{ path('app_cart') }}" class="floating-cart">
    <i class="fas fa-shopping-cart"></i>
    {% if cartCount > 0 %}
      <span class="badge">{{ cartCount }}</span>
    {% endif %}
  </a>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script>
    $(document).on('click', '.btn.add-to-cart', function(e) {
      e.preventDefault();
      const $btn = $(this);
      const url  = $btn.attr('href');
      $btn.prop('disabled', true);

      $.ajax({
        url: url,
        method: 'GET',
        dataType: 'json',
        success(json) {
          const $badge = $('.floating-cart .badge');
          if ($badge.length) {
            $badge.text(json.cartCount);
          } else {
            $('.floating-cart').append('<span class="badge">'+json.cartCount+'</span>');
          }
          $btn.removeAttr('href');
          $btn.removeClass('btn-success add-to-cart')
              .addClass('btn-secondary already-added')
              .text('Déjà ajouté');
        }
      });
    });
  </script>
{% endblock %}
