{# templates/produit/shop.html.twig #}
{% extends 'base.html.twig' %}
{% set session = app.session %}

{% block title %}Bienvenue dans notre Boutique{% endblock %}

{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ asset('front/css/produit/shop.css') }}?v=1.0">
{% endblock %}

{% block body %}
<div class="container mt-5">
  <h1 class="shop-title">Bienvenue dans notre Shop</h1>

  {% for message in app.flashes('success') %}
    <div class="alert alert-success">{{ message }}</div>
  {% endfor %}
  {% for message in app.flashes('warning') %}
    <div class="alert alert-warning">{{ message }}</div>
  {% endfor %}

  <div class="row">
    {% for produit in produits %}
      <div class="col-md-3 mb-4 d-flex align-items-stretch">
        <div class="card product-card shadow-sm border-0 position-relative">
          <a href="{{ path('app_favoris_toggle', {id: produit.id_produit}) }}"
             class="fav-icon {% if produit.id_produit in session.get('favoris', []) %}active{% endif %}">
            <i class="fas fa-heart"></i>
          </a>

          <img src="{{ asset('uploads/' ~ produit.photo) }}" class="card-img-top" alt="{{ produit.nom }}">

          <div class="card-body d-flex flex-column">
            <h5 class="card-title">{{ produit.nom|upper }}</h5>
            <p class="price">{{ produit.prix }} €</p>
            <div class="mt-auto btn-group w-100">
              <a href="{{ path('app_produit_detail', {id: produit.id_produit}) }}" class="btn btn-details">Détails</a>
        <a href="{{ path('app_cart_add', {id: produit.id_produit}) }}"
   class="btn btn-success add-to-cart"
   data-product-id="{{ produit.id_produit }}">
  <i class="fas fa-shopping-bag me-2"></i> Ajouter
</a>

            </div>
          </div>
        </div>
      </div>
    {% else %}
      <p class="col-12 text-center">Aucun produit disponible.</p>
    {% endfor %}
  </div>
</div>

<a href="{{ path('app_cart') }}" class="floating-cart">
  <i class="fas fa-shopping-cart"></i>
  {% if cartCount > 0 %}
    <span class="badge">{{ cartCount }}</span>
  {% endif %}
</a>
{% endblock %}

{% block javascripts %}
  {{ parent() }}
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
  $(document).on('click', '.btn.add-to-cart', function(e) {
  e.preventDefault();
  const $btn = $(this);
  const url  = $btn.attr('href');

  $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Ajout…');

  $.ajax({
    url: url,
    method: 'GET',
    dataType: 'json',
    success(json) {
      const $badge = $('.floating-cart .badge');
      if ($badge.length) {
        $badge.text(json.cartCount);
      } else {
        $('.floating-cart').append('<span class="badge">'+json.cartCount+'</span>');
      }
      $btn.removeClass('btn-success').addClass('btn-secondary')
          .html('<i class="fas fa-check me-2"></i>Ajouté');
      setTimeout(() => {
        $btn.prop('disabled', false)
            .removeClass('btn-secondary').addClass('btn-success')
            .html('<i class="fas fa-shopping-bag me-2"></i>Ajouter');
      }, 1500);
    },
    error(xhr) {
      console.error('AJAX Error:', xhr.status, xhr.responseText);
      alert('Erreur lors de l’ajout au panier.');
      $btn.prop('disabled', false)
          .html('<i class="fas fa-shopping-bag me-2"></i>Ajouter');
    }
  });
});

  </script>
{% endblock %}
